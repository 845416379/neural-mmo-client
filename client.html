<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Projekt Godsword demo</title>
    </head>
    <body>
        <div id="container"><br />Generating world...</div>
        <div id="info">
           (left click: move, middle click: rotate, mouse wheel: zoom)
        </div>

        <script src="three.js/build/three.js"></script>
        <script src="three.js/examples/js/controls/OrbitControls.js"></script>
        <script src="three.js/examples/js/utils/BufferGeometryUtils.js"></script>
        <script src="three.js/examples/js/ImprovedNoise.js"></script>
        <script src="three.js/examples/js/WebGL.js"></script>
        <script src="three.js/examples/js/loaders/OBJLoader.js"></script>
        <script src="three.js/examples/js/loaders/MTLLoader.js"></script>
        <script src="three.js/examples/js/libs/stats.min.js"></script>
        <script src="threex/WindowResize.js"></script>
        <script src="threex/FullScreen.js"></script>
        <script src="textsprite.js"></script>

        <script src="comms.js"></script>
        <script src="consts.js"></script>
        <script src="terrain.js"></script>
        <script src="engine.js"></script>
        <script src="player.js"></script>
        <script src="obj.js"></script>

        <script id="vertexShader" type="x-shader/x-vertex">
        uniform sampler2D bumpTexture;
        uniform float bumpScale;

        varying float vAmount; varying vec2 vUV;
        varying vec3 newPosition;

        vec2 tilePos;
        float tile;
        float border;
        float val;
        float tol = 0.025;
        float mag = 1.0;

        void main()
        {
            vec3 position = vec3(position.x + 64.0*40.0, position.y+64.0*40.0, position.z);
            vUV = uv;
            //vec4 bumpData = texture2D( bumpTexture, uv);
            tilePos = floor(position.xy / 64.0);
            vAmount = 255.0*texture2D(bumpTexture, tilePos/80.0).r;

            //Check if we are on a border
            vec2 err = position.xy/64.0 - tilePos;

            /*
            val = 255.0*texture2D(bumpTexture, vec2(tilePos.x-1.0, tilePos.y-1.0)/80.0).r;
            if (val == 1.0) { vAmount = mag; }
            */

            if (err.x < tol) {
               val = 255.0*texture2D(bumpTexture, vec2(tilePos.x-1.0, tilePos.y)/80.0).r;
               if (val == 1.0) { vAmount = mag; }
            }

            if (err.y < tol) {
               val = 255.0*texture2D(bumpTexture, vec2(tilePos.x, tilePos.y-1.0)/80.0).r;
               if (val == 1.0) { vAmount = mag; }
            }

            if (err.x < tol && err.y < tol) {
               val = 255.0*texture2D(bumpTexture, vec2(tilePos.x-1.0, tilePos.y-1.0)/80.0).r;
               if (val == 1.0) { vAmount = mag; }
            }


            /*
            if (err.x < tol && err.y < tol) {
               vAmount = 2.0;
            }
            */

            if (position.x == 0.0 || position.y == 0.0 || 
                  position.x / 64.0 == 80.0 || position.y / 64.0 == 80.0) {
               vAmount = 0.0;
            }


            //border = float(err.x < 0.01 || err.y < 0.01);
            //Prefer 1.0 on border. Use tile interior otherwise.
            //vAmount = (1.0-border)*val + 1.0*border;


            // assuming map is grayscale it doesn't matter if you use r, g, or b.

            // move the position along the normal
            newPosition = position + normal * bumpScale * vAmount;

            gl_Position = projectionMatrix * modelViewMatrix * vec4(
                newPosition, 1.0 );
        }
        </script>

        <script id="fragmentShader" type="x-shader/x-vertex">
        uniform sampler2D oceanTexture;
        uniform sampler2D sandyTexture;
        uniform sampler2D grassTexture;
        uniform sampler2D rockyTexture;
        uniform sampler2D snowyTexture;
        uniform sampler2D forestTexture;
        uniform sampler2D lavaTexture;
        uniform sampler2D scrubTexture;
        uniform sampler2D stoneTexture;
        uniform sampler2D tileTexture;

        vec2 tilePos;
        float tile;
        float tol = 0.05;

        varying vec2 vUV;

        varying float vAmount;
        varying vec3 newPosition;

        void main() {

            tilePos = floor(newPosition.xy / 64.0);
            vec2 tileUV = newPosition.xy/64.0 - floor(newPosition.xy / 64.00);
            tile = 255.0 * texture2D(tileTexture, tilePos/80.0).r;


            vec4 water  = texture2D( oceanTexture,  tileUV* 1.0 );
            vec4 grass  = texture2D( grassTexture,  tileUV* 1.0 );
            vec4 rocky  = texture2D( rockyTexture,  tileUV* 1.0 );
            vec4 snowy  = texture2D( snowyTexture,  tileUV* 1.0 );
            vec4 forest = texture2D( forestTexture, tileUV* 1.0 );
            vec4 lava   = texture2D( lavaTexture,   tileUV* 1.0 );
            vec4 scrub  = texture2D( scrubTexture,  tileUV* 1.0 );
            vec4 stone  = texture2D( stoneTexture,  tileUV* 1.0 );
            vec4 sandy  = texture2D( sandyTexture,  tileUV* 1.0 );
            /*
            vec4 sandy = (
                smoothstep(0.24, 0.27, vAmount) -
                smoothstep(0.28, 0.31, vAmount)
                ) * texture2D( sandyTexture, tileUV* 10.0 );
            */
 

            lava = lava * float(tile==0.0);
            water = sandy * float(tile == 1.0);
            grass = grass * float(tile == 2.0 );
            scrub = scrub * float(tile == 3.0);
            forest = forest * float(tile==4.0);
            stone = stone * float(tile==5.0);
            rocky = rocky * 0.0;
            snowy = snowy * 0.0;
            gl_FragColor = (vec4(0.0, 0.0, 0.0, 1.0) + 
                  water + grass + rocky + snowy + 
                  forest + scrub + stone + lava);

            float modx = tilePos.x - (2.0 * floor(tilePos.x/2.0));
            float mody = tilePos.y - (2.0 * floor(tilePos.y/2.0));
            gl_FragColor = 0.8*gl_FragColor + 0.2*gl_FragColor*(abs(modx-mody));
            //Check if we are on a border
            vec2 err = newPosition.xy/64.0 - tilePos;

            //Debug shader
            /*
            if (err.x < tol) {
               gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);
            }

            if (err.y < tol) {
               gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
            }

            if (err.x < tol && err.y < tol) {
               gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);
            }
            */


        }

        </script>

        <script src="client.js"></script>
    </body>
</html>
